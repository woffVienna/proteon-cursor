openapi: 3.0.3
info:
  title: Proteon Identity Service API
  version: 0.1.0
  description: Internal identity-service API. Exposed publicly only via api-gateway proxy routes.

servers:
  - url: http://localhost:8081
    description: Internal (VPC) service endpoint

tags:
  - name: auth
  - name: well-known
  - name: internal

paths:
  /v1/auth/login:
    post:
      tags: [auth]
      operationId: postV1AuthLogin
      summary: Login with username/email + password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
      responses:
        "200":
          description: Tokens issued
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPairResponse"
        "400":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/BadRequest"
        "401":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/Unauthorized"
        "429":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/TooManyRequests"
        "500":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/InternalError"

  /v1/auth/refresh:
    post:
      tags: [auth]
      operationId: postV1AuthRefresh
      summary: Refresh access token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshRequest"
      responses:
        "200":
          description: Tokens refreshed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenPairResponse"
        "400":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/BadRequest"
        "401":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/Unauthorized"
        "429":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/TooManyRequests"
        "500":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/InternalError"

  /v1/auth/logout:
    post:
      tags: [auth]
      operationId: postV1AuthLogout
      summary: Logout (revoke refresh token)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogoutRequest"
      responses:
        "204":
          description: Logged out
        "400":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/BadRequest"
        "401":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/Unauthorized"
        "429":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/TooManyRequests"
        "500":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/InternalError"

  /v1/me:
    get:
      tags: [auth]
      operationId: getV1Me
      summary: Get current subject
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Subject info
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "401":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/Unauthorized"
        "500":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/InternalError"

  /v1/.well-known/jwks.json:
    get:
      tags: [well-known]
      operationId: getV1WellKnownJwks
      summary: JSON Web Key Set (JWKS)
      responses:
        "200":
          description: JWKS document
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/JwksResponse"
        "500":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/InternalError"

  /v1/health:
    get:
      tags: [internal]
      operationId: getV1Health
      summary: Health check
      responses:
        "200":
          description: Healthy
          content:
            application/json:
              schema:
                $ref: "../../../libs/api/openapi/common/components.yml#/components/schemas/HealthResponse"
        "500":
          $ref: "../../../libs/api/openapi/common/errors.yml#/components/responses/InternalError"

components:
  securitySchemes:
    bearerAuth:
      $ref: "../../../libs/api/openapi/common/components.yml#/components/securitySchemes/bearerAuth"

  schemas:
    LoginRequest:
      type: object
      additionalProperties: false
      required: [login, password]
      properties:
        login:
          type: string
          minLength: 1
          maxLength: 320
          example: demo@proteon.dev
        password:
          type: string
          format: password
          minLength: 1
          maxLength: 1024
          example: demo
        tenant:
          type: string
          minLength: 1
          maxLength: 64
          example: proteon.dev

    RefreshRequest:
      type: object
      additionalProperties: false
      required: [refresh_token]
      properties:
        refresh_token:
          type: string
          minLength: 20
          maxLength: 4096

    LogoutRequest:
      type: object
      additionalProperties: false
      required: [refresh_token]
      properties:
        refresh_token:
          type: string
          minLength: 20
          maxLength: 4096

    TokenPairResponse:
      type: object
      additionalProperties: false
      required: [access_token, token_type, expires_in, refresh_token]
      properties:
        access_token:
          type: string
        token_type:
          type: string
          enum: [Bearer]
        expires_in:
          type: integer
          format: int32
          minimum: 1
          example: 600
        refresh_token:
          type: string
        scope:
          type: string
          example: "mcp:read mcp:write"
        session_id:
          type: string

    MeResponse:
      type: object
      additionalProperties: false
      required: [sub, tenant]
      properties:
        sub:
          type: string
        tenant:
          type: string
        scopes:
          type: array
          items:
            type: string
        session_id:
          type: string

    JwksResponse:
      type: object
      additionalProperties: false
      required: [keys]
      properties:
        keys:
          type: array
          items:
            $ref: "#/components/schemas/Jwk"

    Jwk:
      type: object
      additionalProperties: true
      required: [kty, kid]
      properties:
        kty:
          type: string
        kid:
          type: string
        use:
          type: string
        alg:
          type: string
